#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
================================================================================
V3 æ¨¡å‹è¨“ç·´è…³æœ¬ - è¼•é‡åŒ–å¾®èª¿ç‰ˆæœ¬ (Lightweight)
================================================================================
æœ¬è…³æœ¬åŸ·è¡Œå®Œæ•´çš„ V3 è¨“ç·´æµç¨‹ï¼š
1. æ¸…é™¤èˆŠçš„ç‰¹å¾µå¿«å–ï¼ˆå¼·åˆ¶ç”¨æ–°çš„ 30 æ¬¡ MC Dropout æ¡æ¨£é‡ç®—ï¼‰
2. åŸ·è¡Œé è¨“ç·´ (Pre-training)
3. åŸ·è¡Œå¾®èª¿ (Fine-tuning) - è¼•é‡åŒ–æ­¥æ•¸

èˆ‡ V4 çš„å·®ç•°ï¼š
- Buy Agent Fine-tune: 200K æ­¥ (è¼•é‡åŒ–)
- Sell Agent Fine-tune: 100K æ­¥ (è¼•é‡åŒ–)

ä½œè€…ï¼šPhil Liang (Generated by Gemini)
æ—¥æœŸï¼š2025-12-07
================================================================================
"""

import os
import sys
import glob
import shutil
import pickle

# ç¢ºä¿èƒ½å¼•ç”¨ ptrl_hybrid_system
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

# è¨­å®š TensorFlow æ—¥èªŒç­‰ç´š
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '2'

import yfinance as yf
import pandas as pd

# =============================================================================
# è¨­å®š
# =============================================================================
PROJECT_PATH = os.path.dirname(os.path.abspath(__file__))
CACHE_DIR = os.path.join(PROJECT_PATH, "data", "processed")
DATA_PATH = os.path.join(PROJECT_PATH, "data", "raw")
V3_MODELS_PATH = os.path.join(PROJECT_PATH, "models_hybrid_v3")
V3_RESULTS_PATH = os.path.join(PROJECT_PATH, "results_hybrid_v3")
SPLIT_DATE = '2023-01-01'

# è¨“ç·´æ­¥æ•¸è¨­å®š
PRETRAIN_BUY_STEPS = 1_000_000
PRETRAIN_SELL_STEPS = 500_000
# V3: è¼•é‡åŒ–å¾®èª¿æ­¥æ•¸
FINETUNE_BUY_STEPS = 200_000
FINETUNE_SELL_STEPS = 100_000


def clear_cache():
    """Step A: æ¸…é™¤ç‰¹å¾µå¿«å–"""
    print("\n" + "=" * 60)
    print("ğŸ§¹ Step A: æ¸…é™¤ç‰¹å¾µå¿«å–")
    print("=" * 60)
    
    if not os.path.exists(CACHE_DIR):
        print(f"[Info] å¿«å–ç›®éŒ„ä¸å­˜åœ¨: {CACHE_DIR}")
        return
    
    pkl_files = glob.glob(os.path.join(CACHE_DIR, "*.pkl"))
    
    if not pkl_files:
        print("[Info] æ²’æœ‰æ‰¾åˆ° .pkl å¿«å–æª”æ¡ˆ")
        return
    
    print(f"[Info] æ‰¾åˆ° {len(pkl_files)} å€‹å¿«å–æª”æ¡ˆ")
    
    for f in pkl_files:
        try:
            os.remove(f)
            print(f"  âœ… å·²åˆªé™¤: {os.path.basename(f)}")
        except Exception as e:
            print(f"  âš ï¸ åˆªé™¤å¤±æ•—: {os.path.basename(f)} - {e}")
    
    print("[Done] å¿«å–æ¸…é™¤å®Œæˆ")


def run_pretraining():
    """Step B: é è¨“ç·´"""
    print("\n" + "=" * 60)
    print("ğŸ“ Step B: é è¨“ç·´ (Pre-training)")
    print("=" * 60)
    print(f"  Buy Agent:  {PRETRAIN_BUY_STEPS:,} steps")
    print(f"  Sell Agent: {PRETRAIN_SELL_STEPS:,} steps")
    print(f"  è¼¸å‡ºè·¯å¾‘:   {V3_MODELS_PATH}")
    print("=" * 60)
    
    # ç¢ºä¿è¼¸å‡ºç›®éŒ„å­˜åœ¨
    os.makedirs(V3_MODELS_PATH, exist_ok=True)
    os.makedirs(DATA_PATH, exist_ok=True)
    
    # å¼•ç”¨ä¸»ç³»çµ±
    import ptrl_hybrid_system as hybrid
    
    # æª¢æ¸¬è£ç½®
    import torch
    device = "cuda" if torch.cuda.is_available() else "cpu"
    print(f"[System] ä½¿ç”¨è£ç½®: {device}")
    
    # è¼‰å…¥ LSTM æ¨¡å‹
    print("\n[System] è¼‰å…¥ LSTM æ¨¡å‹...")
    hybrid.load_best_lstm_models()
    
    # æº–å‚™è¨“ç·´è³‡æ–™ (ä½¿ç”¨æ­£ç¢ºçš„ API)
    print("\n[Data] ä¸‹è¼‰å…¨çƒæŒ‡æ•¸è³‡æ–™...")
    raw_data = hybrid.fetch_index_data(DATA_PATH, start_date="2000-01-01", end_date=SPLIT_DATE)
    
    print("\n[Data] è¨ˆç®—ç‰¹å¾µ (ä½¿ç”¨æ–°çš„ 30 æ¬¡ MC Dropout æ¡æ¨£)...")
    train_data = {}
    benchmark_df = raw_data.get("^TWII")
    for ticker, df in raw_data.items():
        try:
            processed = hybrid.calculate_features(df, benchmark_df, ticker, use_cache=False)  # ä¸ç”¨å¿«å–
            if len(processed) > 100:
                train_data[ticker] = processed
                print(f"  âœ… {ticker}: {len(processed)} rows")
        except Exception as e:
            print(f"  âš ï¸ {ticker}: {e}")
    
    # åŸ·è¡Œé è¨“ç·´
    print(f"\n[Training] é–‹å§‹é è¨“ç·´...")
    hybrid.run_pretraining(train_data, V3_MODELS_PATH, device)
    
    print(f"\n[Done] é è¨“ç·´å®Œæˆï¼æ¨¡å‹å·²å„²å­˜è‡³ {V3_MODELS_PATH}/")


def run_finetuning():
    """Step C: å¾®èª¿ (è¼•é‡åŒ–)"""
    print("\n" + "=" * 60)
    print("ğŸ¯ Step C: å¾®èª¿ (Fine-tuning - è¼•é‡åŒ–)")
    print("=" * 60)
    print(f"  Buy Agent:  {FINETUNE_BUY_STEPS:,} steps (è¼•é‡åŒ–)")
    print(f"  Sell Agent: {FINETUNE_SELL_STEPS:,} steps (è¼•é‡åŒ–)")
    print(f"  è¼¸å‡ºè·¯å¾‘:   {V3_MODELS_PATH}")
    print("=" * 60)
    
    # å¼•ç”¨ä¸»ç³»çµ±
    import ptrl_hybrid_system as hybrid
    
    # æª¢æ¸¬è£ç½®
    import torch
    device = "cuda" if torch.cuda.is_available() else "cpu"
    print(f"[System] ä½¿ç”¨è£ç½®: {device}")
    
    # è¼‰å…¥ LSTM æ¨¡å‹ (å¦‚æœé‚„æ²’è¼‰å…¥)
    hybrid.load_best_lstm_models()
    
    # æº–å‚™ TWII è³‡æ–™
    print("\n[Data] æº–å‚™ ^TWII è³‡æ–™...")
    cache_path = os.path.join(CACHE_DIR, "_TWII_features.pkl")
    
    if os.path.exists(cache_path):
        print(f"[Cache] è¼‰å…¥ ^TWII ç‰¹å¾µ...")
        with open(cache_path, 'rb') as f:
            twii_full_df = pickle.load(f)
    else:
        print("[Compute] Loading ^TWII from local CSV...")
        # [Modify] ä½¿ç”¨æœ¬åœ°è³‡æ–™è¼‰å…¥å‡½æ•¸
        twii_raw = hybrid._load_local_twii_data(start_date="2000-01-01")
        
        twii_full_df = hybrid.calculate_features(twii_raw, twii_raw, ticker="^TWII", use_cache=True)
    
    print(f"[Data] ^TWII è³‡æ–™: {len(twii_full_df)} rows")
    
    # åˆ†å‰²è³‡æ–™
    split_date = pd.Timestamp(SPLIT_DATE)
    twii_finetune_df = twii_full_df[twii_full_df.index < split_date]
    twii_eval_df = twii_full_df[twii_full_df.index >= split_date]
    
    print(f"  Fine-tuning set: {len(twii_finetune_df)} rows (< {SPLIT_DATE})")
    print(f"  Eval set:        {len(twii_eval_df)} rows (>= {SPLIT_DATE})")
    
    finetune_data = {'^TWII': twii_finetune_df}
    eval_data = {'^TWII': twii_eval_df}
    
    # åŸ·è¡Œå¾®èª¿ (å‚³å…¥è¼•é‡åŒ–æ­¥æ•¸)
    print(f"\n[Training] é–‹å§‹å¾®èª¿ (è¼•é‡åŒ–)...")
    hybrid.run_finetuning(finetune_data, eval_data, V3_MODELS_PATH, device,
                          finetune_buy_steps=FINETUNE_BUY_STEPS,
                          finetune_sell_steps=FINETUNE_SELL_STEPS)
    
    print(f"\n[Done] å¾®èª¿å®Œæˆï¼æœ€çµ‚æ¨¡å‹å·²å„²å­˜è‡³ {V3_MODELS_PATH}/")


def print_next_steps():
    """å°å‡ºå¾ŒçºŒæ­¥é©Ÿæç¤º"""
    print("\n" + "=" * 60)
    print("âœ… V3 æ¨¡å‹è¨“ç·´æµç¨‹å·²å®Œæˆï¼")
    print("=" * 60)
    print(f"""
ğŸ“ æ¨¡å‹å„²å­˜ä½ç½®:
   {V3_MODELS_PATH}/ppo_buy_twii_final.zip
   {V3_MODELS_PATH}/ppo_sell_twii_final.zip

ï¿½ daily_ops_dual.py å·²é è¨­ä½¿ç”¨ V3 å’Œ V4 æ¨¡å‹é€²è¡Œé›™ç­–ç•¥æ¨è«–
""")


def check_pretrain_complete():
    """æª¢æŸ¥é è¨“ç·´æ˜¯å¦å®Œæˆ"""
    buy_base = os.path.join(V3_MODELS_PATH, "ppo_buy_base.zip")
    sell_base = os.path.join(V3_MODELS_PATH, "ppo_sell_base.zip")
    return os.path.exists(buy_base) and os.path.exists(sell_base)


def check_finetune_complete():
    """æª¢æŸ¥å¾®èª¿æ˜¯å¦å®Œæˆ"""
    buy_final = os.path.join(V3_MODELS_PATH, "ppo_buy_twii_final.zip")
    sell_final = os.path.join(V3_MODELS_PATH, "ppo_sell_twii_final.zip")
    return os.path.exists(buy_final) and os.path.exists(sell_final)


def check_backtest_complete():
    """æª¢æŸ¥å›æ¸¬æ˜¯å¦å®Œæˆ"""
    result_chart = os.path.join(V3_RESULTS_PATH, "final_performance.png")
    return os.path.exists(result_chart)


def run_backtesting_step():
    """Step D: å›æ¸¬"""
    print("\n" + "=" * 60)
    print("ğŸ“Š Step D: å›æ¸¬ (Backtesting for ^TWII)")
    print("=" * 60)
    print(f"  è¼¸å‡ºè·¯å¾‘:   {V3_RESULTS_PATH}")
    print("=" * 60)
    
    # å»ºç«‹è¼¸å‡ºç›®éŒ„
    os.makedirs(V3_RESULTS_PATH, exist_ok=True)
    
    # å¼•ç”¨ä¸»ç³»çµ±
    import ptrl_hybrid_system as hybrid
    from stable_baselines3 import PPO
    
    # è¼‰å…¥ LSTM æ¨¡å‹
    hybrid.load_best_lstm_models()
    
    # æº–å‚™ TWII è³‡æ–™
    print("\n[Data] æº–å‚™ ^TWII è³‡æ–™...")
    cache_path = os.path.join(CACHE_DIR, "_TWII_features.pkl")
    
    if os.path.exists(cache_path):
        print(f"[Cache] è¼‰å…¥ ^TWII ç‰¹å¾µ...")
        with open(cache_path, 'rb') as f:
            twii_full_df = pickle.load(f)
    else:
        print("[Compute] Loading ^TWII from local CSV...")
        # [Modify] ä½¿ç”¨æœ¬åœ°è³‡æ–™è¼‰å…¥å‡½æ•¸
        twii_raw = hybrid._load_local_twii_data(start_date="2000-01-01")
        twii_full_df = hybrid.calculate_features(twii_raw, twii_raw, ticker="^TWII", use_cache=True)
    
    # åˆ†å‰²è³‡æ–™
    split_date = pd.Timestamp(SPLIT_DATE)
    twii_backtest_df = twii_full_df[twii_full_df.index >= split_date]
    
    print(f"[Data] å›æ¸¬æœŸé–“: {twii_backtest_df.index[0].strftime('%Y-%m-%d')} ~ {twii_backtest_df.index[-1].strftime('%Y-%m-%d')}")
    print(f"[Data] å›æ¸¬è³‡æ–™: {len(twii_backtest_df)} rows")
    
    # è¼‰å…¥ Fine-tuned æ¨¡å‹
    print("\n[Model] è¼‰å…¥ V3 Fine-tuned æ¨¡å‹...")
    buy_model = PPO.load(os.path.join(V3_MODELS_PATH, "ppo_buy_twii_final.zip"))
    sell_model = PPO.load(os.path.join(V3_MODELS_PATH, "ppo_sell_twii_final.zip"))
    
    # åŸ·è¡Œå›æ¸¬
    print("\n[Backtest] åŸ·è¡Œä¸­...")
    metrics = hybrid.run_backtesting(twii_backtest_df, buy_model, sell_model, V3_RESULTS_PATH, twii_full_df)
    
    print(f"\n[Done] å›æ¸¬å®Œæˆï¼çµæœå·²å„²å­˜è‡³ {V3_RESULTS_PATH}/")
    return metrics


def main():
    print("=" * 60)
    print("ğŸš€ V3 æ¨¡å‹è¨“ç·´è…³æœ¬ (è¼•é‡åŒ–å¾®èª¿ç‰ˆæœ¬)")
    print(f"   Buy Fine-tune: {FINETUNE_BUY_STEPS:,} steps | Sell Fine-tune: {FINETUNE_SELL_STEPS:,} steps")
    print("=" * 60)
    
    # Step A: æ¸…é™¤å¿«å– (åªåœ¨éœ€è¦æ™‚åŸ·è¡Œ)
    # å¦‚æœé è¨“ç·´å·²å®Œæˆï¼Œä¸æ¸…é™¤å¿«å–
    if not check_pretrain_complete():
        clear_cache()
    else:
        print("\n[Skip] Step A: å¿«å–æ¸…é™¤ (é è¨“ç·´å·²å®Œæˆï¼Œä¸éœ€æ¸…é™¤)")
    
    # Step B: é è¨“ç·´ (æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ)
    if check_pretrain_complete():
        print("\n" + "=" * 60)
        print("âœ… [Skip] Step B: é è¨“ç·´å·²å®Œæˆ")
        print(f"   Buy Base:  {V3_MODELS_PATH}/ppo_buy_base.zip")
        print(f"   Sell Base: {V3_MODELS_PATH}/ppo_sell_base.zip")
        print("=" * 60)
    else:
        run_pretraining()
    
    # Step C: å¾®èª¿ (æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ)
    if check_finetune_complete():
        print("\n" + "=" * 60)
        print("âœ… [Skip] Step C: å¾®èª¿å·²å®Œæˆ")
        print(f"   Buy Final:  {V3_MODELS_PATH}/ppo_buy_twii_final.zip")
        print(f"   Sell Final: {V3_MODELS_PATH}/ppo_sell_twii_final.zip")
        print("=" * 60)
    else:
        run_finetuning()
    
    # Step D: å›æ¸¬ (æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ)
    if check_backtest_complete():
        print("\n" + "=" * 60)
        print("âœ… [Skip] Step D: å›æ¸¬å·²å®Œæˆ")
        print(f"   Result: {V3_RESULTS_PATH}/final_performance.png")
        print("=" * 60)
    else:
        run_backtesting_step()
    
    # å°å‡ºå¾ŒçºŒæ­¥é©Ÿ
    print_next_steps()


if __name__ == "__main__":
    main()
